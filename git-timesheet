#!/usr/bin/env bash

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

AUTHOR="${1:-$(git config user.name)}"
YEAR="${2:-$(date +%Y)}"
OUTPUT_DIR="timesheets"

print_header() {
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}  Git Timesheet Generator${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

translate_commit_type() {
    local msg="$1"

    if [[ $msg =~ ^feat ]]; then
        echo "Feature implementation"
    elif [[ $msg =~ ^fix ]]; then
        echo "Bug fix"
    elif [[ $msg =~ ^refactor ]]; then
        echo "Code refactoring"
    elif [[ $msg =~ ^chore ]]; then
        echo "Maintenance"
    elif [[ $msg =~ ^test ]]; then
        echo "Testing"
    elif [[ $msg =~ ^docs ]]; then
        echo "Documentation"
    elif [[ $msg =~ ^style ]]; then
        echo "Code style"
    elif [[ $msg =~ ^ci ]]; then
        echo "CI/CD pipeline"
    elif [[ $msg =~ ^perf ]]; then
        echo "Performance optimization"
    elif [[ $msg =~ ^build ]]; then
        echo "Build system"
    else
        echo "Development"
    fi
}

format_commit_message() {
    local msg="$1"
    
    msg=$(echo "$msg" | sed 's/^[a-z]*(\([^)]*\)): /\1: /')
    msg=$(echo "$msg" | sed 's/^[a-z]*: //')
    
    echo "$msg" | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}'
}

generate_month_timesheet() {
    local month_num="$1"
    local month_name=$(date -j -f "%Y-%m" "${YEAR}-${month_num}" "+%B" 2>/dev/null || date -d "${YEAR}-${month_num}-01" "+%B" 2>/dev/null)
    local output_file="${OUTPUT_DIR}/${YEAR}-${month_num}-${month_name}.md"

    echo -e "${YELLOW}ðŸ“ Generating timesheet for ${month_name} ${YEAR}...${NC}"

    local start_date="${YEAR}-${month_num}-01"
    local end_date=$(date -j -v+1m -f "%Y-%m-%d" "$start_date" "+%Y-%m-%d" 2>/dev/null || date -d "$start_date +1 month" "+%Y-%m-%d" 2>/dev/null)

    local commits=$(git log --author="$AUTHOR" \
        --after="$start_date" \
        --before="$end_date" \
        --pretty=format:"%ai|%s" \
        --date=iso)

    if [ -z "$commits" ]; then
        echo -e "${YELLOW}   âš ï¸  No commits found for ${month_name}${NC}"
        return
    fi

    cat > "$output_file" << EOF
# Timesheet ${month_name} ${YEAR}
**Developer**: ${AUTHOR}

---

EOF

    local daily_data=""

    while IFS= read -r line; do
        if [ -z "$line" ]; then continue; fi

        local datetime="${line%%|*}"
        local message="${line#*|}"
        local date="${datetime%% *}"
        local time="${datetime#* }"
        time="${time%% *}"

        daily_data+="$date|$time|$message"$'\n'
    done <<< "$commits"

    local unique_dates=$(echo "$daily_data" | cut -d'|' -f1 | sort -u)
    local days_worked=$(echo "$unique_dates" | wc -l | xargs)

    for date in $unique_dates; do
        local day_commits=$(echo "$daily_data" | grep "^$date|")
        local times=$(echo "$day_commits" | cut -d'|' -f2)
        local first_time=$(echo "$times" | head -1 | cut -c1-5)
        local last_time=$(echo "$times" | tail -1 | cut -c1-5)

        local day_name=$(date -j -f "%Y-%m-%d" "$date" "+%A" 2>/dev/null || date -d "$date" "+%A" 2>/dev/null)
        local day_num=$(date -j -f "%Y-%m-%d" "$date" "+%d" 2>/dev/null || date -d "$date" "+%d" 2>/dev/null)
        local display_month=$(date -j -f "%Y-%m-%d" "$date" "+%B" 2>/dev/null || date -d "$date" "+%B" 2>/dev/null)

        cat >> "$output_file" << EOF
## ${day_name} ${day_num} ${display_month}
**Time range**: ${first_time} - ${last_time}

**Activities**:
EOF

        while IFS='|' read -r _ _ commit_msg; do
            if [ -z "$commit_msg" ]; then continue; fi
            
            local formatted_msg=$(format_commit_message "$commit_msg")
            echo "- $formatted_msg" >> "$output_file"
        done <<< "$day_commits"

        echo "" >> "$output_file"
        echo "---" >> "$output_file"
        echo "" >> "$output_file"
    done

    local total_commits=$(echo "$commits" | wc -l | xargs)
    
    cat >> "$output_file" << EOF

## Monthly Summary

**Working days**: ${days_worked}

**Macro-activities**:
EOF

    local all_scopes=$(echo "$daily_data" | cut -d'|' -f3 | grep -o '([^)]*)' | tr -d '()' | sort -u)
    local scope_count=0
    
    while IFS= read -r scope; do
        if [ -n "$scope" ] && [ "$scope_count" -lt 15 ]; then
            local scope_commits=$(echo "$daily_data" | cut -d'|' -f3 | grep -c "($scope)" || echo "0")
            local main_type=$(echo "$daily_data" | grep "($scope)" | cut -d'|' -f3 | head -1)
            local activity_type=$(translate_commit_type "$main_type")
            
            echo "- ${activity_type}: ${scope} (${scope_commits} commits)" >> "$output_file"
            scope_count=$((scope_count + 1))
        fi
    done <<< "$all_scopes"
    
    cat >> "$output_file" << EOF

**Total commits**: ${total_commits}

EOF

    echo -e "${GREEN}   âœ… File created: ${output_file}${NC}"
}

main() {
    if [ ! -d ".git" ]; then
        echo -e "${RED}âŒ Error: Not a Git repository${NC}"
        echo "Please run this script from the root of a Git repository."
        exit 1
    fi

    print_header
    echo -e "${BLUE}Author:${NC} $AUTHOR"
    echo -e "${BLUE}Year:${NC} $YEAR"
    echo ""

    mkdir -p "$OUTPUT_DIR"

    echo -e "${YELLOW}ðŸ” Finding months with commits...${NC}"

    local months=$(git log --author="$AUTHOR" \
        --after="${YEAR}-01-01" \
        --before="$((YEAR + 1))-01-01" \
        --pretty=format:"%ai" \
        --date=iso | awk '{print $1}' | cut -d'-' -f1-2 | sort -u | cut -d'-' -f2)

    if [ -z "$months" ]; then
        echo -e "${RED}âŒ No commits found for author '$AUTHOR' in year $YEAR${NC}"
        exit 1
    fi

    echo -e "${GREEN}âœ… Found commits in $(echo "$months" | wc -l | xargs) months${NC}"
    echo ""

    while IFS= read -r month; do
        generate_month_timesheet "$month"
    done <<< "$months"

    echo ""
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}âœ… Generation completed!${NC}"
    echo -e "${GREEN}   Files saved in: ${OUTPUT_DIR}/${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

main

